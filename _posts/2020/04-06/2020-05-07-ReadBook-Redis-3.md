---
layout: post
title: 读书笔记之《Redis开发与运维》—— 三
category: 读书笔记
tags: [读书笔记]
---

由于内容过多，分一个系列来写，这是第三篇。

## 五、持久化

&ensp;&ensp;&ensp;&ensp;持久化功能有效的避免因进程退出造成的数据丢失问题，当下次重启时利用之前持久化的文件即可实现数据恢复。

### 1、RDB

RDB持久化是把当前进程数据生成快照保存在硬盘的过程，触发RDB持久化过程分为手动触发和自动触发。手动触发的命令有：save和bgsave命令。
save命令会阻塞当前Redis服务器，直到RDB过程完成为止，对于内存比较大的实例会造成长时间阻塞，线上不要用。bgsave命令，Redis进程执
行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，时间很短。

RDB的优点：<br/>
RDB是一个紧凑压缩的二进制文件，代表Redis在某个时间点上的数据快照。适合于备份、全量复制的场景；</br>
Redis加载RDB恢复数据远快于AOF的方式。

RDB的缺点：</br>
RDB方式数据没法做到实时持久化、秒级持久化，因为bgsave每次运行都要执行fork操作创建子进程，属于重量级操作，频繁执行成本过高；</br>
RDB文件使用特定二进制格式保存，Redis版本演进过程中有多个格式的RDB版本，存在老版本Redis无法兼容新版本RDB格式的问题。

### 2、AOF

AOF持久化以独立日志的方式记录每次写命令，重启时再重新执行AOF文件中的命令达到恢复数据的目的，AOF的主要目的是解决了数据持久化的实时性。

AOF的工作流程操作：命令写入、文件同步、文件重写、重启加载。所有的写入命令会追加到aof_buf缓冲区中，缓存区根据对应的策略向硬盘做同步
操作（同步策略建议使用everysec），随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩的目的，当Redis服务器重启时，可以加载AOF
文件进行数据恢复。


## 六、复制

本章大部分是运维层面的知识。简要整理下重点内容：<br/>
Redis通过复制功能实现主节点的多个副本，从节点可以灵活的通过slaveof命令建立或断开复制流程；<br/>
复制支持树状结构，从节点可以复制另一个从节点，实现一层层向下的复制流，复制分为全量复制和部分复制；<br/>
主从节点之间维护心跳和偏移量检查机制，保证主从节点通信正常和数据一致；<br/>
Redis为了保证高性能复制过程是异步的，写命令处理完后直接返回给客户端，不等待从节点复制完成，因此从节点数据集会有延迟。


## 七、阻塞

本章主要也是运维层面的知识。

Redis是典型的单线程架构，所有的读写操作都是在一条主线程中完成的，当Redis用于高并发场景时，这条主线程就变成了它的生命线。导致阻塞问题
的场景大致分为内在原因和外在原因：<br/>
内在原因：不合理的使用API或数据结构、CPU饱和、持久化阻塞等；<br/>
外在原因：CPU竞争、内存交换、网络问题等。


## 八、理解内存

### 1、内存消耗

### 2、内存管理

### 3、内存优化

